<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analysis History - Eye-O</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #333;
    }
    .container {
      background: #fff; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 1100px; width: 100%; margin: 0 auto; padding: 32px;
    }
    .header {
      text-align: center; margin-bottom: 32px;
    }
    .header h1 {
      color: #2c3e50; margin-bottom: 10px; font-size: 2.2rem; font-weight: 700;
    }
    .header .subtitle {
      color: #7f8c8d; font-size: 1.1rem; margin-bottom: 20px;
    }
    .oracle-icon { 
      font-size: 2.5rem; margin-bottom: 15px; 
      animation: pulse 3s infinite;
    }
    @keyframes pulse { 
      0%, 100% { transform: scale(1); } 
      50% { transform: scale(1.05); } 
    }
    .history-grid {
      display: grid; gap: 16px; margin: 24px 0;
    }
    .history-card {
      background: #f8f9fa; border-radius: 14px; padding: 20px; 
      border-left: 4px solid #667eea; transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    .history-card:hover {
      transform: translateY(-2px); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 12px; gap: 16px;
    }
    .card-date {
      color: #7f8c8d; font-size: 0.9rem; font-weight: 500;
      white-space: nowrap; flex-shrink: 0;
    }
    .score-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;
      font-size: 0.9rem; flex-shrink: 0;
    }
    .score-high { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
    .score-medium { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
    .score-low { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
    .card-idea {
      color: #2c3e50; font-size: 1rem; line-height: 1.4; margin-bottom: 16px;
      overflow: hidden; text-overflow: ellipsis;
      max-height: 2.8em; /* Roughly 2 lines */
    }
    /* Modern browsers with line-clamp support */
    @supports (-webkit-line-clamp: 2) {
      .card-idea {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-clamp: 2;
      }
    }
    .card-actions {
      display: flex; gap: 10px; align-items: center;
    }
    .view-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px;
      font-weight: 500; font-size: 0.9rem; transition: transform 0.2s ease;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .view-btn:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .toolbar {
      display: flex; gap: 12px; justify-content: center; margin: 32px 0 16px;
      flex-wrap: wrap;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 12px 24px; border-radius: 25px; 
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
      font-weight: 600; transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }
    .empty-state {
      text-align: center; padding: 60px 20px; color: #7f8c8d;
    }
    .empty-state .icon {
      font-size: 4rem; margin-bottom: 20px; opacity: 0.5;
    }
    .empty-state h3 {
      margin-bottom: 10px; color: #2c3e50;
    }
    /* Responsive design */
    @media (max-width: 768px) {
      .container { padding: 20px; margin: 10px; }
      .header h1 { font-size: 1.8rem; }
      .card-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .toolbar { flex-direction: column; align-items: center; }
      .btn { width: 100%; justify-content: center; max-width: 280px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="oracle-icon">üîÆ</div>
      <h1>Analysis History</h1>
      <p class="subtitle">Your past product insights and strategic analyses</p>
    </div>
    
    {% if items %}
      <div class="history-grid">
        {% for item in items %}
          <div class="history-card" data-url="{{ request.url_for('view_record', rec_id=item.id) }}">
            <div class="card-header">
              <div class="card-date">
                {% set date_parts = item.created_at.split('T') %}
                {% set date_only = date_parts[0] if date_parts else item.created_at %}
                {{ date_only }}
              </div>
              <div class="score-badge {% if item.score >= 7 %}score-high{% elif item.score >= 4 %}score-medium{% else %}score-low{% endif %}">
                {{ item.score }}/10
              </div>
            </div>
            <div class="card-idea">{{ item.idea }}</div>
            <div class="card-actions">
              <a href="{{ request.url_for('view_record', rec_id=item.id) }}" class="view-btn" onclick="event.stopPropagation();">
                <span>View Analysis</span> ‚Üí
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="icon">üìù</div>
        <h3>No analyses yet</h3>
        <p>Start by analyzing your first product idea to see your history here.</p>
      </div>
    {% endif %}
    
    <div class="toolbar">
      <a href="{{ request.url_for('homepage') }}" class="btn">
        Analyze New Idea
      </a>
      {% if items %}
        <button onclick="exportHistory()" class="btn btn-secondary">
          Export History
        </button>
      {% endif %}
    </div>
  </div>
  
  {% if items %}
  <script id="history-data" type="application/json">
{{ items | tojson }}
  </script>
  {% endif %}
  
  <script>
    // Format dates more nicely
    document.addEventListener('DOMContentLoaded', function() {
      const dateElements = document.querySelectorAll('.card-date');
      dateElements.forEach(el => {
        const dateStr = el.textContent.trim();
        try {
          const date = new Date(dateStr);
          if (!isNaN(date)) {
            const options = { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            };
            el.textContent = date.toLocaleDateString('en-US', options);
          }
        } catch (e) {
          // Keep original format if parsing fails
        }
      });
    });
    
    // Export functionality
    function exportHistory() {
      const historyDataElement = document.getElementById('history-data');
      let historyItems = [];
      
      if (historyDataElement) {
        try {
          historyItems = JSON.parse(historyDataElement.textContent);
        } catch (e) {
          console.error('Failed to parse history data:', e);
          return;
        }
      }
      
      const historyData = {
        exported_at: new Date().toISOString(),
        total_analyses: historyItems.length,
        analyses: historyItems.map(item => ({
          id: item.id,
          idea: item.idea,
          score: item.score,
          created_at: item.created_at,
          view_url: window.location.origin + '/view/' + item.id
        }))
      };;
      
      const blob = new Blob([JSON.stringify(historyData, null, 2)], { 
        type: 'application/json' 
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'eye-o-history-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        location.href = '/';
      }
    });
  </script>
</body>
</html>