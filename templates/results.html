<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analysis Results - Eye-O</title>

  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:1100px;width:100%;margin:0 auto;padding:32px}
    .header{text-align:center;margin-bottom:24px}
    .score-ring{width:120px;height:120px;border-radius:50%;margin:16px auto;border:10px solid #ddd;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900}
    .score-label{font-size:1.2rem;font-weight:600;margin:8px 0;color:#2c3e50}
    .high{border-color:#27ae60}.medium{border-color:#f39c12}.low{border-color:#e74c3c}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin:18px 0}
    .card{background:#f8f9fa;border-radius:14px;padding:20px;border-left:4px solid #667eea}
    .card h3{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:8px;font-size:1.1rem}
    .subsection{margin:12px 0;padding:8px;background:#fff;border-radius:8px}
    .subsection h4{color:#667eea;margin-bottom:8px;font-size:0.95rem;font-weight:600}
    .selected-name{font-size:1.3rem;font-weight:700;color:#2c3e50;padding:8px;background:linear-gradient(135deg,#667eea20,#764ba220);border-radius:8px}
    .list-item{background:#fff;padding:10px;margin:6px 0;border-radius:8px;border-left:3px solid #667eea}
    .chips span{display:inline-block;background:#fff;border-left:3px solid #667eea;border-radius:8px;padding:6px 8px;margin:3px}
    .palette{display:flex;gap:10px;margin:10px 0}
    .sw{width:40px;height:40px;border-radius:50%;border:3px solid #ddd}
    .domain-check{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0}
    .available{color:#27ae60;font-weight:700}.taken{color:#e74c3c;font-weight:700}
    .toolbar {display: flex;gap: 10px;justify-content: center;margin: 20px 0;flex-wrap: wrap;}
    .btn {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: #fff;border: none;padding: 12px 16px;border-radius: 25px;text-decoration: none;display: inline-flex;align-items: center;gap: 8px;font-weight: 600;font-size: 0.9rem;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .icon-btn{padding:10px;border-radius:50%;min-width:44px;justify-content:center}
    .sticky{position:fixed;right:16px;bottom:16px}
    pre{background:#0b1021;color:#d0e3ff;padding:14px;border-radius:10px;overflow:auto;max-height:300px}
    .muted{color:#2c3e50;font-size:.95rem}
    .handle-available{color:#27ae60;font-weight:700}
    .handle-taken{color:#e74c3c;font-weight:700}
    .handle-unknown{color:#9b59b6;font-weight:700}
    .timestamp {color: #7f8c8d;font-size: 0.9rem;margin-top: 8px;font-style: italic;
    
}
    
  </style>
<script>
let analytics = {
  track: (event) => fetch(`/analytics/${event}`, {method: 'POST'}).catch(() => {})
};

sessionStorage.setItem('lastAnalysisId', '{{ record_id }}');

// Track page view
analytics.track('page_view');
</script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Analysis Complete</h1>
      <p><strong>Your Idea:</strong> "{{ idea }}"</p>
      <div class="score-ring {% if analysis.viability_score >= 7 %}high{% elif analysis.viability_score >= 4 %}medium{% else %}low{% endif %}">
        {{ analysis.viability_score }}/10
      </div>
      <div class="score-label">{{ analysis.score_label }}</div>
      <p class="muted">{{ analysis.score_explanation }}</p>
     
    </div>

    <div class="grid">
      <!-- Product Section (replaces Positioning + Names) -->
      <div class="card">
        <h3>üéØ Product</h3>
        <div class="subsection">
          <h4>Name</h4>
          <div class="selected-name">{{ analysis.product.selected_name }}</div>
        </div>
        <div class="subsection">
          <h4>Positioning</h4>
          <p>{{ analysis.product.positioning }}</p>
        </div>
        <div class="subsection">
          <h4>Domains</h4>
          <div class="domain-check">
            {% for ext, available in (domains.get(analysis.product.selected_name, {})).items() %}
              <span class="{% if available %}available{% else %}taken{% endif %}">
                {{ analysis.product.selected_name|lower|replace(' ', '') }}{{ ext }} {% if available %}‚úì{% else %}‚úó{% endif %}
              </span>
            {% endfor %}
          </div>
          {% if handles and handles.get(analysis.product.selected_name) %}
            {% set h = handles.get(analysis.product.selected_name) %}
            <div class="domain-check" style="margin-top:8px;">
              IG: <span class="{% if h.instagram is true %}handle-available{% elif h.instagram is false %}handle-taken{% else %}handle-unknown{% endif %}">{{ '‚úì' if h.instagram is true else ('?' if h.instagram is none else '‚úó') }}</span> ‚Ä¢
              X: <span class="{% if h.x is true %}handle-available{% elif h.x is false %}handle-taken{% else %}handle-unknown{% endif %}">{{ '‚úì' if h.x is true else ('?' if h.x is none else '‚úó') }}</span> ‚Ä¢
              TikTok: <span class="{% if h.tiktok is true %}handle-available{% elif h.tiktok is false %}handle-taken{% else %}handle-unknown{% endif %}">{{ '‚úì' if h.tiktok is true else ('?' if h.tiktok is none else '‚úó') }}</span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Target Section (consolidated Users + GTM + TAM/SAM/SOM) -->
      <div class="card">
        <h3>üéØ Target</h3>
        <div class="subsection">
          <h4>Users</h4>
          <p>{{ analysis.target.users }}</p>
        </div>
        <div class="subsection">
          <h4>How?</h4>
          {% for channel in analysis.target.how %}
            <div class="list-item">{{ channel }}</div>
          {% endfor %}
        </div>
        <div class="subsection">
          <h4>My Focus</h4>
          <p>{{ analysis.target.my_focus }}</p>
        </div>
      </div>

      <div class="card">
        <h3>üí¨ Tagline</h3>
        <div class="list-item"><em>"{{ analysis.product.tagline }}"</em></div>
      </div>

      <div class="card">
        <h3>üé® Brand Personality</h3>
        <p style="margin-bottom:12px">{{ analysis.brand_personality }}</p>
        <div class="palette">
          {% for color in analysis.color_palette %}
            <div style="display: flex; flex-direction: column; align-items: center; margin: 0 5px;">
              <div class="sw" data-color="{{ (color or '#ffffff')|lower }}" title="{{ color }}"></div>
              <span style="font-size: 0.8rem; margin-top: 4px; color: #666;">{{ color }}</span>
            </div>
          {% endfor %}
        </div>
        <div class="chips">
          {% for kw in analysis.mood_keywords %}
            <span>#{{ kw }}</span>
          {% endfor %}
        </div>
      </div>
      {% if analysis.mood_images %}
      <div class="card">
        <h3>üñºÔ∏è Visual Mood Board</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
          {% for image_url in analysis.mood_images %}
            <img src="{{ image_url }}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;" alt="Mood board image">
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div class="card">
        <h3>‚ö†Ô∏è Riskiest Assumption ‚Üí Counter-move</h3>
        {% for r in analysis.key_risks %}
          <div class="list-item">{{ r }}</div>
        {% endfor %}
        <h4 style="color:#667eea;margin:12px 0 8px;font-size:0.95rem">Counter-moves</h4>
        {% for c in analysis.counter_moves %}
          <div class="list-item">{{ c }}</div>
        {% endfor %}
      </div>

      <div class="card">
        <h3>üöÄ Opportunities + Revenue</h3>
        {% for o in analysis.opportunities %}
          <div class="list-item">{{ o }}</div>
        {% endfor %}
        <div class="subsection">
          <h4>Revenue Model</h4>
          <p>{{ analysis.revenue_model }}</p>
        </div>
      </div>

      <div class="card">
        <h3>üîç Similar Products</h3>
        {% for s in analysis.similar_products %}
          <div class="list-item">
            <a href="https://www.google.com/search?q={{ s|urlencode }}" target="_blank" style="color:#667eea;text-decoration:none">
              {{ s }} ‚Üó
            </a>
          </div>
        {% endfor %}
      </div>

      <div class="card">
        <h3>üóìÔ∏è 30-Day Launch Plan</h3>
        {% for step in analysis.launch_30_day_plan %}
          <div class="list-item">{{ loop.index }}. {{ step }}</div>
        {% endfor %}
      </div>

      <div class="card">
        <h3>‚úÖ Next Steps</h3>
        {% for step in analysis.next_steps %}
          <div class="list-item">
            <a href="#" onclick="getResourceLink('{{ step }}')" style="color:#667eea;text-decoration:none">
              {{ loop.index }}. {{ step }} ‚Üí
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="toolbar">
      {% if record_id %}
        <button class="btn" id="downloadBtn" title="Download PDF">‚¨á Download PDF</button>
        <button class="btn" id="copyBtn" title="Copy Analysis">üìã Copy</button>
        <button class="btn" id="shareBtn" title="Share Link">üîó Share</button>
      {% endif %}
      <a href="{{ request.url_for('homepage') }}" class="btn">üîÆ Analyze Another Idea</a>
    </div>
  </div>

<script id="analysis-data" type="application/json">
{{ analysis_json | tojson | safe }}
</script>

<script>
  // Apply color swatches
  document.querySelectorAll('.sw').forEach(el => {
    el.style.backgroundColor = el.dataset.color || '#ffffff';
  });

  const dataNode = document.getElementById('analysis-data');
  let analysisObj = {};
  try { 
    let data = dataNode ? dataNode.textContent : '{}';

    let parsed = JSON.parse(data);
  
  // If it's still a string, parse again
    if (typeof parsed === 'string') {
      parsed = JSON.parse(parsed);
    }
  
    analysisObj = parsed;
  } catch (e) {
    console.log("Parse error:", e);
  }

  const analysisText = JSON.stringify(analysisObj, null, 2);
  const recordId = "{{ record_id or '' }}";
  const ideaText = "{{ idea or 'N/A' }}";

  // Button functionality
  const downloadBtn = document.getElementById('downloadBtn');
  const copyBtn = document.getElementById('copyBtn');
  const shareBtn = document.getElementById('shareBtn');

  if (downloadBtn) {
  downloadBtn.addEventListener('click', () => {
    // Call PDF endpoint instead of creating a JSON blob
    window.location.href = `/download/${recordId}`;
  });
  }

  if (copyBtn) {
  copyBtn.addEventListener('click', async () => {
    analytics.track('copy_used');

    console.log("analysisObj in copy function:", analysisObj);
    console.log("Copy button clicked");
    console.log("dataNode:", dataNode);
    console.log("analysisObj:", analysisObj);
    console.log("analysisObj type:", typeof analysisObj);
    console.log("analysisObj keys:", Object.keys(analysisObj));
    console.log("Full analysisObj:", JSON.stringify(analysisObj, null, 2));
    console.log("copyBtn element:", document.getElementById('copyBtn'));
    console.log("analysisObj structure:", analysisObj);
    // Format the analysis data nicely
    const formatted = `EYE-O ANALYSIS REPORT
    
Idea: ${ideaText}
Score: ${analysisObj.viability_score || 'N/A'}/10
Product Name: ${analysisObj.product?.selected_name || 'N/A'}
Tagline: ${analysisObj.product?.tagline || 'N/A'}

POSITIONING:
${analysisObj.product?.positioning || 'N/A'}

TARGET USERS:
${analysisObj.target?.users || 'N/A'}

REVENUE MODEL:
${analysisObj.revenue_model || 'N/A'}

KEY RISKS:
${(analysisObj.key_risks || []).map((risk, i) => `${i+1}. ${risk}`).join('\n')}

COUNTER MOVES:
${(analysisObj.counter_moves || []).map((move, i) => `${i+1}. ${move}`).join('\n')}

OPPORTUNITIES:
${(analysisObj.opportunities || []).map((opp, i) => `${i+1}. ${opp}`).join('\n')}

LAUNCH PLAN:
${(analysisObj.launch_30_day_plan || []).map((step, i) => `${i+1}. ${step}`).join('\n')}

NEXT STEPS:
${(analysisObj.next_steps || []).map((step, i) => `${i+1}. ${step}`).join('\n')}`;

  try {
  // Use the older clipboard method that works with HTTP
    const textarea = document.createElement('textarea');
    textarea.value = formatted;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  
    copyBtn.innerHTML = '‚úÖ';
    setTimeout(() => copyBtn.innerHTML = 'üìã', 1500);
  } catch (e) {
    alert("Copy failed");
  }
  });
  }

  if (shareBtn && recordId) {
    shareBtn.addEventListener('click', async () => {
      const url = `${location.origin}/view/${recordId}`;
      try {
          const textarea = document.createElement('textarea');
          textarea.value = url;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
            
          shareBtn.innerHTML = 'üîó ‚úÖ Copied!';
          setTimeout(() => shareBtn.innerHTML = 'üîó Share', 1500);
      } catch (e) {
        prompt("Copy this link:", url);
      }
    });
  }

  // Resource links for next steps
  function getResourceLink(step) {
    const resources = {
      'Market research': 'https://surveymonkey.com',
      'MVP build': 'https://replit.com',
      'User testing': 'https://usertesting.com',
      'Beta launch': 'https://producthunt.com',
      'Beta testing': 'https://testflight.apple.com'
    };
    
    const match = Object.keys(resources).find(key => 
      step.toLowerCase().includes(key.toLowerCase())
    );
    
    if (match) {
      window.open(resources[match], '_blank');
    } else {
      window.open(`https://www.google.com/search?q=${encodeURIComponent(step + ' tools')}`, '_blank');
    }
  }
</script>
</body>
</html>